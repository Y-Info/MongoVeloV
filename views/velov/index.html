{% extends "layout.html" %}

{% block content %}

<script>
    var latitude = [];
    var longitude = [];
    var address = [];
    var commune = [];
    var available_bikes = [];
    var availability = [];
    var last_update = [];
    var stationname = [];
</script>


<h2>Carte interactive</h2>

<div id="map">
    <!-- Ici s'affichera la carte -->
</div>
    {% for MongoOBJ in velov %}
        <script>
            var coord = '{{ MongoOBJ.geometry.coordinates }}';
            var splitcoord = coord.split(',');
            latitude.push(splitcoord[1]);
            longitude.push(splitcoord[0]);
        </script>
        {% for MarkerDetail in MongoOBJ.properties %}
            <script>
                var TempAdress = '{{ MarkerDetail.address }}';
                console.log(TempAdress);
                address.push(TempAdress);

                var TempName = '{{ MarkerDetail.name }}';
                console.log(TempName);
                stationname.push(TempName);

                var TempCommune = '{{ MarkerDetail.commune }}';
                console.log(TempCommune);
                commune.push(TempCommune);
                var TempAvailable_bikes  = '{{ MarkerDetail.available_bikes }}';
                console.log(TempAvailable_bikes );
                available_bikes.push(TempAvailable_bikes);
                var TempAvailability  = '{{ MarkerDetail.availability }}';
                console.log(TempAvailability );
                availability.push(TempAvailability);
                var TempLast_update  = '{{ MarkerDetail.last_update }}';
                console.log(TempLast_update );
                last_update.push(TempLast_update);


            </script>
        {% endfor %}
    {% endfor %}


<script type="text/javascript">
    // On initialise la latitude et la longitude de Paris (centre de la carte)
    var lat = 45.761432;
    var lon = 4.856454;

    console.log(stationname);

    var macarte = null;

    var vertIcon = new L.Icon({
        iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    var orangeIcon = new L.Icon({
        iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    var grisIcon = new L.Icon({
        iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-grey.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    var bleuIcon = new L.Icon({
        iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
    var rougeIcon = new L.Icon({
        iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });






    // Fonction d'initialisation de la carte
    function initMap() {
        // Créer l'objet "macarte" et l'insèrer dans l'élément HTML qui a l'ID "map"
        macarte = L.map('map').setView([lat, lon], 14);
        // Leaflet ne récupère pas les cartes (tiles) sur un serveur par défaut. Nous devons lui préciser où nous souhaitons les récupérer. Ici, openstreetmap.fr
        L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
            // Il est toujours bien de laisser le lien vers la source des données
            attribution: 'données © <a href="//osm.org/copyright">OpenStreetMap</a>/ODbL - rendu <a href="//openstreetmap.fr">OSM France</a>',
            minZoom: 1,
            maxZoom: 20
        }).addTo(macarte);


        for (var i = 0; i < longitude.length; i++) {
            var templat = latitude[i];
            var templong = longitude[i];


            switch (availability[i]) {
                case 'Vert':
                    var marker = L.marker([templat, templong], {icon: vertIcon}).addTo(macarte);
                    break;
                case 'Gris':
                    var marker = L.marker([templat, templong], {icon: grisIcon}).addTo(macarte);
                    break;
                case 'Orange':
                    var marker = L.marker([templat, templong], {icon: orangeIcon}).addTo(macarte);
                    break;
                case 'Bleu':
                    var marker = L.marker([templat, templong], {icon: bleuIcon}).addTo(macarte);
                    break;
                default:
                    var marker = L.marker([templat, templong], {icon: rougeIcon }).addTo(macarte);
            }


            var mystring = "<b> Nom : " + stationname[i] + "</b><br/>" + "Commune : " + commune[i] +"<br/>" + "Adress : " + address[i] +"<br/>" + "Nb velo dispo. : " + available_bikes[i] +"<br/>" ;
            marker.bindPopup(mystring);
        }

    }
    window.onload = function(){
        // Fonction d'initialisation qui s'exécute lorsque le DOM est chargé
        initMap();
    };




</script>







{% endblock %}



